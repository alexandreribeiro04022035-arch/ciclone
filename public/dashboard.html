<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel - CICLONE</title>
<style>
    body { margin: 0; background: #eef2f5; font-family: Arial, sans-serif; }
    .header { background: #0066cc; color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 20; font-size: 19px; font-weight: bold; }
    .menu { margin-top: 70px; display: flex; justify-content: space-around; background: #fff; padding: 10px 0; border-bottom: 1px solid #ccc; }
    .menu a { text-decoration: none; color: #0066cc; font-weight: bold; font-size: 15px; }
    .saldo-info { background: #198754; color: white; padding: 15px; margin: 10px 20px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; }
    .user-info { background: white; margin: 10px 20px; padding: 15px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.15); }
    .info-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
    .info-item:last-child { border-bottom: none; }
    .info-label { font-weight: bold; color: #555; }
    .info-value { color: #333; }
    .grid { padding: 20px; display: grid; gap: 15px; grid-template-columns: repeat(2, 1fr); }
    .box { background: white; padding: 25px 10px; border-radius: 8px; text-align: center; font-size: 17px; font-weight: bold; color: #333; box-shadow: 0 0 8px rgba(0,0,0,0.15); cursor: pointer; transition: 0.2s; }
    .box:hover { transform: scale(1.06); box-shadow: 0 0 12px rgba(0,0,0,0.25); }
    .stats-box { background: white; margin: 10px 20px; padding: 15px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.15); }
    .stats-title { font-weight: bold; color: #0066cc; margin-bottom: 10px; }
</style>
</head>
<body onload="carregarDadosUsuario()">

<div class="header">Painel CICLONE</div>

<div class="menu">
    <a href="#">Conta</a>
    <a href="viewads-botton.html">Ganhe Dinheiro</a>
    <a href="#" onclick="logout()">Sair</a>
</div>

<div class="saldo-info" id="saldoInfo">Carregando saldo...</div>

<div class="user-info">
    <div class="info-item">
        <span class="info-label">ID:</span>
        <span class="info-value" id="userId">-</span>
    </div>
    <div class="info-item">
        <span class="info-label">Email:</span>
        <span class="info-value" id="userEmail">-</span>
    </div>
    <div class="info-item">
        <span class="info-label">Nome:</span>
        <span class="info-value" id="userNome">-</span>
    </div>
    <div class="info-item">
        <span class="info-label">Chave PIX:</span>
        <span class="info-value" id="userPix">-</span>
    </div>
    <div class="info-item">
        <span class="info-label">Telefone:</span>
        <span class="info-value" id="userTelefone">-</span>
    </div>
    <div class="info-item">
        <span class="info-label">Data de Cadastro:</span>
        <span class="info-value" id="userDataCadastro">-</span>
    </div>
</div>

<div class="stats-box">
    <div class="stats-title">üìä ESTAT√çSTICAS DE CLICKS</div>
    <div class="info-item">
        <span class="info-label">Total de Cliques:</span>
        <span class="info-value" id="totalClicks">0</span>
    </div>
    <div class="info-item">
        <span class="info-label">Cliques Hoje:</span>
        <span class="info-value" id="clicksHoje">0</span>
    </div>
    <div class="info-item">
        <span class="info-label">√öltimo Click:</span>
        <span class="info-value" id="ultimoClick">Nunca</span>
    </div>
</div>

<div class="stats-box">
    <div class="stats-title">üí∞ SISTEMA DE CR√âDITOS</div>
    <div class="info-item">
        <span class="info-label">Recebendo Cr√©ditos:</span>
        <span class="info-value" id="recebendoCreditos">N√£o</span>
    </div>
    <div class="info-item">
        <span class="info-label">Limite Atingido:</span>
        <span class="info-value" id="limiteAtingido">N√£o</span>
    </div>
    <div class="info-item">
        <span class="info-label">Saldo para Retirada:</span>
        <span class="info-value" id="saldoRetirada">R$ 0,00</span>
    </div>
</div>

<div class="grid">
    <div class="box" onclick="irParaAnuncios()">Ver An√∫ncios</div>
    <div class="box" onclick="sacarDinheiro()">Sacar Dinheiro</div>
    <div class="box" onclick="fazerUpgrade()">Fazer Upgrade</div>
</div>

<script>
async function carregarDadosUsuario() {
    const user = JSON.parse(localStorage.getItem('user'));
    
    if (!user || !user.id) {
        window.location.href = 'login-top.html';
        return;
    }

    try {
        // PRIMEIRO: Tenta endpoint /api/dashboard
        let dados = null;
        
        try {
            const respostaDashboard = await fetch(`https://ciclone-62mq.onrender.com/api/dashboard/${user.id}`);
            if (respostaDashboard.ok) {
                dados = await respostaDashboard.json();
                console.log('Dashboard API response:', dados);
            }
        } catch (dashboardError) {
            console.log('Dashboard endpoint falhou, tentando login...');
        }
        
        // SEGUNDO: Se dashboard falhou, usa endpoint de login
        if (!dados || !dados.success) {
            const respostaLogin = await fetch('https://ciclone-62mq.onrender.com/api/login-completo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: user.email, 
                    senha: user.senha 
                })
            });
            
            dados = await respostaLogin.json();
            console.log('Login API response:', dados);
            
            if (dados.success) {
                // Reestrutura para formato compat√≠vel
                dados = {
                    success: true,
                    user: dados.user,
                    clicks: dados.user.clicks || { total_clicks: 0, clicks_hoje: 0, data_ultimo_click: null }
                };
            }
        }
        
        if (dados.success) {
            const userData = dados.user;
            const clicksData = dados.clicks || {};
            
            // ‚úÖ CORRE√á√ÉO: Formata saldo com 4 casas decimais
            const saldo = parseFloat(userData.saldo_redisponivel || 0);
            const saldoFormatado = saldo.toFixed(4);
            
            // ATUALIZA LOCALSTORAGE
            localStorage.setItem('user', JSON.stringify({
                ...user,
                ...userData,
                clicks: clicksData
            }));
            
            // PREENCHE DADOS DO USU√ÅRIO
            document.getElementById('saldoInfo').innerHTML = `Saldo Dispon√≠vel: R$ ${saldoFormatado}`;
            document.getElementById('userId').textContent = userData.id || '-';
            document.getElementById('userEmail').textContent = userData.email || '-';
            document.getElementById('userNome').textContent = userData.nome || 'N√£o informado';
            document.getElementById('userPix').textContent = userData.chavepix || 'N√£o cadastrada';
            document.getElementById('userTelefone').textContent = userData.telefone || 'N√£o cadastrado';
            
            if (userData.data_criacao) {
                const data = new Date(userData.data_criacao);
                document.getElementById('userDataCadastro').textContent = data.toLocaleDateString();
            } else {
                document.getElementById('userDataCadastro').textContent = '-';
            }
            
            // PREENCHE SISTEMA DE CR√âDITOS
            document.getElementById('recebendoCreditos').textContent = userData.recebendo_creditos ? 'Sim ‚úÖ' : 'N√£o ‚ùå';
            document.getElementById('limiteAtingido').textContent = userData.limite_atingido ? 'Sim ‚ö†Ô∏è' : 'N√£o ‚úÖ';
            document.getElementById('saldoRetirada').textContent = `R$ ${saldoFormatado}`;
            
            // PREENCHE ESTAT√çSTICAS DE CLICKS
            document.getElementById('totalClicks').textContent = clicksData.total_clicks || 0;
            document.getElementById('clicksHoje').textContent = clicksData.clicks_hoje || 0;
            
            if (clicksData.data_ultimo_click) {
                const data = new Date(clicksData.data_ultimo_click);
                document.getElementById('ultimoClick').textContent = data.toLocaleString();
            } else {
                document.getElementById('ultimoClick').textContent = 'Nunca';
            }
            
            console.log('‚úÖ Dashboard carregado. Saldo:', saldoFormatado);
            
        } else {
            alert('Erro: ' + (dados.error || 'N√£o foi poss√≠vel carregar dados'));
        }
        
    } catch (erro) {
        console.error('Erro ao carregar dados:', erro);
        
        // FALLBACK: Usa dados do localStorage
        const saldo = parseFloat(user.saldo_redisponivel || 0).toFixed(4);
        document.getElementById('saldoInfo').innerHTML = `Saldo Dispon√≠vel: R$ ${saldo}`;
        document.getElementById('saldoRetirada').textContent = `R$ ${saldo}`;
        document.getElementById('userEmail').textContent = user.email || '-';
        document.getElementById('userNome').textContent = user.nome || 'N√£o informado';
        
        alert('‚ö†Ô∏è Usando dados locais. Atualize a p√°gina para sincronizar.');
    }
}

function irParaAnuncios() {
    window.location.href = 'viewads-botton.html';
}

function sacarDinheiro() {
    window.location.href = '#';
    alert('Para saques whatsapp 5521999102951');
}

function fazerUpgrade() {
    window.location.href = '#';
    alert('Para fazer upgrade whatsapp 5521 99910 2951');
}

function logout() {
    localStorage.removeItem('user');
    window.location.href = 'index.html';
}
</script>

</body>
</html>
