<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avaliar Produto - CICLONE</title>

<style>
    body {
        margin: 0;
        background: #f5f6f7;
        font-family: Arial;
        text-align: center;
        padding: 20px;
    }

    h2 { margin-bottom: 20px; color: #28a745; }

    #productWindow {
        width: 95%;
        max-width: 900px;
        height: 400px;
        border: 3px solid #28a745;
        margin: 15px auto;
        border-radius: 6px;
        overflow: hidden;
        background: white;
    }

    .product-link {
        display: block;
        width: 100%;
        height: 100%;
        text-decoration: none;
        color: inherit;
    }

    .product-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        cursor: pointer;
    }

    .rating-section {
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-width: 500px;
    }

    .rating-stars {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }

    .star {
        font-size: 35px;
        cursor: pointer;
        color: #ddd;
        margin: 0 3px;
        transition: color 0.2s;
    }

    .star:hover,
    .star.active {
        color: #ffc107;
    }

    .rating-value {
        font-size: 18px;
        margin-bottom: 20px;
        color: #333;
        font-weight: bold;
    }

    #submitRating {
        padding: 12px 30px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }

    #submitRating:hover {
        background: #218838;
    }

    .product-title {
        font-size: 24px;
        font-weight: bold;
        color: #28a745;
        margin-bottom: 10px;
    }

    .product-desc {
        font-size: 16px;
        color: #666;
        max-width: 80%;
    }
</style>
</head>
<body onload="startProduct()">

<h2>Avaliar Produto</h2>

<div id="productWindow">
    <a id="productLink" href="#" target="_blank" onclick="abrirProduto(event)">
        <div class="product-content">
            <div class="product-title" id="productTitle">Carregando produto...</div>
            <div class="product-desc" id="productDesc"></div>
            <p style="color: #888; margin-top: 20px;">Clique para abrir o produto em nova aba</p>
        </div>
    </a>
</div>

<div class="rating-section">
    <h3>Avalie o Produto (0-9)</h3>
    <div class="rating-stars" id="ratingStars"></div>
    <div class="rating-value" id="ratingValue">Sua avaliação: 0/9</div>
    <button id="submitRating" onclick="submitRating()">ENVIAR AVALIAÇÃO E GANHAR CRÉDITO</button>
</div>

<script>
let productId = null;
let user = null;
let currentRating = 0;
let productUrl = "https://example.com";

async function startProduct() {
    user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        window.location.href = 'login-top.html';
        return;
    }

    const params = new URLSearchParams(location.search);
    productId = params.get("id") || 1;

    await carregarProduto();
    initRatingSystem();
}

async function carregarProduto() {
    try {
        const response = await fetch(`https://ciclone-62mq.onrender.com/api/produtos/${productId}`);
        const data = await response.json();
        
        if (data.success) {
            const produto = data.produto;
            productUrl = produto.link_produto;
            document.getElementById('productTitle').textContent = produto.titulo;
            document.getElementById('productDesc').textContent = produto.descricao || 'Sem descrição';
            document.getElementById('productLink').href = productUrl;
        }
    } catch (error) {
        console.log('Erro ao carregar produto:', error);
    }
}

function abrirProduto(event) {
    window.open(productUrl, '_blank');
    event.preventDefault();
    return false;
}

function initRatingSystem() {
    const starsContainer = document.getElementById('ratingStars');
    starsContainer.innerHTML = '';
    
    for (let i = 0; i <= 9; i++) {
        const star = document.createElement('span');
        star.className = 'star';
        star.innerHTML = '★';
        star.dataset.value = i;
        
        star.addEventListener('click', function() {
            setRating(parseInt(this.dataset.value));
        });
        
        starsContainer.appendChild(star);
    }
    setRating(0);
}

function setRating(rating) {
    currentRating = rating;
    const stars = document.querySelectorAll('.star');
    const ratingValue = document.getElementById('ratingValue');
    
    ratingValue.textContent = `Sua avaliação: ${rating}/9`;
    
    stars.forEach(star => {
        const starValue = parseInt(star.dataset.value);
        if (starValue <= rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

async function submitRating() {
    try {
        const response = await fetch('https://ciclone-62mq.onrender.com/api/avaliar-produto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: user.email, 
                produto_id: productId, 
                nota: currentRating 
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('✅ Avaliação registrada e crédito adicionado!');
            window.location.href = 'produtos.html';
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (error) {
        console.log('Erro:', error);
        alert('Erro de conexão');
    }
}
</script>

</body>
</html>
